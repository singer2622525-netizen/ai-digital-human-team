#!/bin/bash

# 完整数据同步脚本
# 同步代码（Git）和数据库文件（云存储）

echo "═══════════════════════════════════════════════════════════"
echo "   🔄 开始同步所有数据"
echo "═══════════════════════════════════════════════════════════"
echo ""

# 进入项目目录
cd "$(dirname "$0")" || exit 1

# 1. Git同步代码和配置
echo "📦 [1/2] 同步代码和配置（Git）..."
echo "───────────────────────────────────────────────────────────"

# 检查是否有未提交的更改
if [ -n "$(git status --porcelain)" ]; then
    echo "📝 发现未提交的更改，正在提交..."
    git add .
    git commit -m "Auto sync: $(date '+%Y-%m-%d %H:%M:%S')" || {
        echo "⚠️  Git提交失败，请检查是否有冲突"
    }
else
    echo "ℹ️  没有未提交的更改"
fi

# 推送到远程仓库
echo "📤 推送到远程仓库..."
if git push origin main 2>&1; then
    echo "✅ Git同步成功"
else
    echo "⚠️  Git推送失败，可能原因："
    echo "   - 网络连接问题"
    echo "   - 远程仓库不存在"
    echo "   - 需要先设置远程仓库: git remote add origin <url>"
fi

echo ""

# 2. 数据库同步
echo "💾 [2/2] 同步数据库文件（云存储）..."
echo "───────────────────────────────────────────────────────────"

if [ -f "同步数据库.sh" ]; then
    bash "同步数据库.sh"
else
    echo "⚠️  未找到同步数据库.sh脚本"
    echo "   请手动同步数据库文件"
fi

echo ""
echo "═══════════════════════════════════════════════════════════"
echo "   ✅ 所有数据同步完成！"
echo "═══════════════════════════════════════════════════════════"
echo ""
echo "💡 提示："
echo "   • 代码已同步到GitHub/GitLab"
echo "   • 数据库已同步到云存储（iCloud/Dropbox）"
echo "   • 知识库数据在RAGFlow服务器上（自动同步）"
echo ""

