# 🔄 数据同步指南

## 📋 目录
1. [数据存储位置](#数据存储位置)
2. [同步方案](#同步方案)
3. [推荐方案](#推荐方案)
4. [详细步骤](#详细步骤)
5. [常见问题](#常见问题)

---

## 📁 数据存储位置

### 需要同步的数据

#### 1. **代码和配置**（必须同步）
```
项目根目录/
├── 03-技术实现/02-功能模块/    # 所有代码
├── 02-数字人设计/              # 角色定义
├── 01-项目构想/                # 项目文档
└── README.md                   # 项目说明
```

#### 2. **数据库文件**（任务、工作流数据）
```
03-技术实现/02-功能模块/storage/
└── digital_humans.db           # SQLite数据库文件
```

**数据库包含：**
- ✅ 任务数据（tasks表）
- ✅ 工作流数据（workflows表）
- ✅ 工作流步骤（workflow_steps表）
- ✅ 知识记录（knowledge_records表）

#### 3. **知识库数据**（自动同步）
- ✅ **RAGFlow知识库** - 存储在服务器上，自动同步
- ✅ 无需手动同步，通过API访问

#### 4. **环境配置**（可选同步）
```
~/DeveloperConfig/环境变量/
└── .env.work                   # RAGFlow配置（可选）
```

---

## 🔄 同步方案

### 方案1: Git同步（推荐）⭐

**优点：**
- ✅ 版本控制
- ✅ 代码和配置自动同步
- ✅ 冲突处理
- ✅ 历史记录

**缺点：**
- ⚠️ 数据库文件较大，需要特殊处理
- ⚠️ 需要GitHub/GitLab账号

**适用场景：**
- 代码和配置同步
- 团队协作
- 版本管理

### 方案2: 云存储同步（iCloud/Dropbox）

**优点：**
- ✅ 自动同步
- ✅ 简单易用
- ✅ 支持大文件

**缺点：**
- ⚠️ 无版本控制
- ⚠️ 可能冲突

**适用场景：**
- 数据库文件同步
- 个人使用
- 快速同步

### 方案3: 手动复制

**优点：**
- ✅ 完全控制
- ✅ 无依赖

**缺点：**
- ⚠️ 容易遗漏
- ⚠️ 手动操作繁琐

**适用场景：**
- 偶尔同步
- 一次性迁移

### 方案4: 混合方案（最佳）⭐⭐⭐

**代码和配置** → Git同步  
**数据库文件** → 云存储同步  
**知识库** → RAGFlow服务器（自动）

---

## ⭐ 推荐方案：Git + 云存储混合

### 架构设计

```
┌─────────────────────────────────────────┐
│         家里Mac                          │
│  ├── 代码/配置 → Git推送                  │
│  └── 数据库文件 → 云存储同步              │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│      GitHub / 云存储服务                 │
│  ├── 代码仓库（Git）                      │
│  └── 数据库文件（iCloud/Dropbox）         │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│         公司Mac                          │
│  ├── Git拉取代码                         │
│  └── 云存储下载数据库                     │
└─────────────────────────────────────────┘
```

---

## 📝 详细步骤

### 步骤1: 设置Git同步（代码和配置）

#### 在家里Mac上：

```bash
# 1. 进入项目目录
cd ~/Documents/Projects/cursor/"00-00软件工程事业部（AI 数字人队伍）"

# 2. 初始化Git（如果还没有）
git init

# 3. 添加远程仓库
git remote add origin https://github.com/your-username/repo-name.git

# 4. 提交代码
git add .
git commit -m "Update: 家里Mac的工作内容"

# 5. 推送到GitHub
git push origin main
```

#### 在公司Mac上：

```bash
# 1. 进入项目目录
cd ~/Documents/Projects/cursor/"00-00软件工程事业部（AI 数字人队伍）"

# 2. 拉取最新代码
git pull origin main

# 3. 如果有冲突，解决冲突后提交
git add .
git commit -m "Merge: 解决冲突"
git push origin main
```

### 步骤2: 设置数据库文件同步

#### 方法A: iCloud同步（Mac推荐）

```bash
# 1. 将数据库文件移动到iCloud目录
mkdir -p ~/Library/Mobile\ Documents/com~apple~CloudDocs/DigitalHumanDB
cp "03-技术实现/02-功能模块/storage/digital_humans.db" \
   ~/Library/Mobile\ Documents/com~apple~CloudDocs/DigitalHumanDB/

# 2. 创建符号链接（这样代码仍然可以正常访问）
cd "03-技术实现/02-功能模块/storage"
mv digital_humans.db digital_humans.db.backup
ln -s ~/Library/Mobile\ Documents/com~apple~CloudDocs/DigitalHumanDB/digital_humans.db digital_humans.db
```

#### 方法B: Dropbox同步

```bash
# 1. 将数据库文件移动到Dropbox目录
mkdir -p ~/Dropbox/DigitalHumanDB
cp "03-技术实现/02-功能模块/storage/digital_humans.db" ~/Dropbox/DigitalHumanDB/

# 2. 创建符号链接
cd "03-技术实现/02-功能模块/storage"
mv digital_humans.db digital_humans.db.backup
ln -s ~/Dropbox/DigitalHumanDB/digital_humans.db digital_humans.db
```

#### 方法C: 手动同步脚本

创建同步脚本 `同步数据库.sh`：

```bash
#!/bin/bash

# 数据库同步脚本

DB_FILE="03-技术实现/02-功能模块/storage/digital_humans.db"
SYNC_DIR="~/Dropbox/DigitalHumanDB"  # 或 iCloud 路径

echo "🔄 同步数据库文件..."

# 备份当前数据库
if [ -f "$DB_FILE" ]; then
    cp "$DB_FILE" "${DB_FILE}.backup.$(date +%Y%m%d_%H%M%S)"
fi

# 从云存储复制（如果存在）
if [ -f "$SYNC_DIR/digital_humans.db" ]; then
    echo "📥 从云存储下载数据库..."
    cp "$SYNC_DIR/digital_humans.db" "$DB_FILE"
else
    echo "ℹ️  云存储中没有数据库文件，使用本地数据库"
fi

# 上传到云存储
echo "📤 上传数据库到云存储..."
mkdir -p "$SYNC_DIR"
cp "$DB_FILE" "$SYNC_DIR/digital_humans.db"

echo "✅ 数据库同步完成！"
```

### 步骤3: 设置自动同步脚本

创建 `同步所有数据.sh`：

```bash
#!/bin/bash

# 完整数据同步脚本

echo "🔄 开始同步所有数据..."
echo ""

# 1. Git同步代码
echo "📦 同步代码和配置（Git）..."
cd ~/Documents/Projects/cursor/"00-00软件工程事业部（AI 数字人队伍）"
git add .
git commit -m "Auto sync: $(date '+%Y-%m-%d %H:%M:%S')" || echo "没有更改"
git push origin main || echo "Git推送失败，请检查网络"

echo ""

# 2. 数据库同步
echo "💾 同步数据库文件..."
./同步数据库.sh

echo ""
echo "✅ 所有数据同步完成！"
```

---

## 🚀 快速使用

### 在家里Mac工作后

```bash
# 一键同步所有数据
cd ~/Documents/Projects/cursor/"00-00软件工程事业部（AI 数字人队伍）"
./同步所有数据.sh
```

### 在公司Mac开始工作前

```bash
# 1. 拉取最新代码
cd ~/Documents/Projects/cursor/"00-00软件工程事业部（AI 数字人队伍）"
git pull origin main

# 2. 同步数据库
./同步数据库.sh

# 3. 启动系统
cd "03-技术实现/02-功能模块/web_interface"
./start.sh
```

---

## 🔧 高级配置

### 配置Git忽略数据库文件

编辑 `.gitignore`：

```gitignore
# 数据库文件（使用云存储同步）
*.db
*.sqlite
*.sqlite3
storage/*.db
```

### 配置Git LFS（大文件支持）

如果数据库文件很大，可以使用Git LFS：

```bash
# 1. 安装Git LFS
brew install git-lfs

# 2. 初始化Git LFS
git lfs install

# 3. 跟踪数据库文件
git lfs track "*.db"

# 4. 提交配置
git add .gitattributes
git commit -m "Add Git LFS tracking for database files"
```

### 自动化同步（cron任务）

设置定时自动同步：

```bash
# 编辑crontab
crontab -e

# 添加以下行（每天18:00自动同步）
0 18 * * * cd ~/Documents/Projects/cursor/"00-00软件工程事业部（AI 数字人队伍）" && ./同步所有数据.sh >> ~/sync.log 2>&1
```

---

## ❓ 常见问题

### Q1: Git冲突怎么办？

**A**: 
```bash
# 1. 查看冲突文件
git status

# 2. 手动解决冲突（编辑文件）

# 3. 标记为已解决
git add <冲突文件>

# 4. 完成合并
git commit -m "Resolve merge conflict"
```

### Q2: 数据库文件冲突怎么办？

**A**: 
- **方案1**: 使用最新版本（推荐）
  ```bash
  # 备份两个版本
  cp digital_humans.db digital_humans.db.home
  cp ~/Dropbox/DigitalHumanDB/digital_humans.db digital_humans.db.work
  
  # 使用时间戳最新的
  if [ digital_humans.db.home -nt digital_humans.db.work ]; then
      cp digital_humans.db.home digital_humans.db
  else
      cp digital_humans.db.work digital_humans.db
  fi
  ```

- **方案2**: 手动合并（复杂）
  - 使用SQLite工具导出数据
  - 手动合并
  - 导入数据库

### Q3: 云存储同步失败？

**A**: 
- 检查网络连接
- 检查云存储服务状态
- 检查文件权限
- 使用手动复制作为备选

### Q4: 如何确保数据不丢失？

**A**: 
- ✅ 定期备份数据库文件
- ✅ 使用Git版本控制
- ✅ 使用RAGFlow知识库（服务器备份）
- ✅ 多设备备份

### Q5: 可以只同步部分数据吗？

**A**: 
可以！修改同步脚本，只同步需要的部分：

```bash
# 只同步代码，不同步数据库
git add .
git commit -m "Update code"
git push origin main

# 或只同步数据库，不同步代码
./同步数据库.sh
```

---

## 📊 同步检查清单

### 在家里Mac（工作后）

- [ ] ✅ 代码已提交到Git
- [ ] ✅ 数据库文件已上传到云存储
- [ ] ✅ Git推送成功
- [ ] ✅ 云存储同步完成

### 在公司Mac（工作前）

- [ ] ✅ Git拉取最新代码
- [ ] ✅ 数据库文件已下载
- [ ] ✅ 系统可以正常启动
- [ ] ✅ 数据完整（任务、工作流）

---

## 🎯 最佳实践

1. **定期同步**
   - 每天工作结束后同步一次
   - 重要工作后立即同步

2. **备份策略**
   - 数据库文件定期备份
   - Git仓库定期推送
   - 重要数据多重备份

3. **冲突处理**
   - 优先使用最新版本
   - 重要数据手动合并
   - 保留备份文件

4. **自动化**
   - 使用脚本自动化同步
   - 设置定时任务
   - 减少手动操作

---

## 📚 相关文档

- [公司Mac使用指南](公司Mac使用指南.md)
- [GitHub发布指南](GitHub发布指南.md)
- [用户操作手册](03-技术实现/02-功能模块/web_interface/用户操作手册.md)

---

**✅ 完成！现在你可以在家里和公司Mac之间无缝同步数据了！**

