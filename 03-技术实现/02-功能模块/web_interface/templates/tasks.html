<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»åŠ¡ç®¡ç† - æ•°å­—äººé˜Ÿä¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }
        
        select, input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .task-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: #f8f9fa;
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
        }
        
        td {
            padding: 15px;
            border-top: 1px solid #eee;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status.pending { background: #fff3cd; color: #856404; }
        .status.assigned { background: #cfe2ff; color: #084298; }
        .status.in_progress { background: #d1ecf1; color: #0c5460; }
        .status.completed { background: #d4edda; color: #155724; }
        .status.failed { background: #f8d7da; color: #721c24; }
        
        .priority {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .priority.low { background: #e9ecef; color: #495057; }
        .priority.medium { background: #fff3cd; color: #856404; }
        .priority.high { background: #ffeaa7; color: #856404; }
        .priority.urgent { background: #f8d7da; color: #721c24; }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .empty {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }
        
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“‹ ä»»åŠ¡ç®¡ç†</h1>
            <div class="filters">
                <div class="filter-group">
                    <label>çŠ¶æ€</label>
                    <select id="statusFilter">
                        <option value="">å…¨éƒ¨</option>
                        <option value="pending">å¾…åˆ†é…</option>
                        <option value="assigned">å·²åˆ†é…</option>
                        <option value="in_progress">è¿›è¡Œä¸­</option>
                        <option value="completed">å·²å®Œæˆ</option>
                        <option value="failed">å¤±è´¥</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>è§’è‰²</label>
                    <select id="roleFilter">
                        <option value="">å…¨éƒ¨</option>
                        <option value="é¡¹ç›®ç»ç†">é¡¹ç›®ç»ç†</option>
                        <option value="ç³»ç»Ÿæ¶æ„å¸ˆ">ç³»ç»Ÿæ¶æ„å¸ˆ</option>
                        <option value="å‰ç«¯å·¥ç¨‹å¸ˆ">å‰ç«¯å·¥ç¨‹å¸ˆ</option>
                        <option value="åç«¯å·¥ç¨‹å¸ˆ">åç«¯å·¥ç¨‹å¸ˆ</option>
                        <option value="è¿ç»´å·¥ç¨‹å¸ˆ">è¿ç»´å·¥ç¨‹å¸ˆ</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>ä»»åŠ¡ç±»å‹</label>
                    <select id="typeFilter">
                        <option value="">å…¨éƒ¨</option>
                        <option value="create_plan">åˆ›å»ºè®¡åˆ’</option>
                        <option value="design_architecture">æ¶æ„è®¾è®¡</option>
                        <option value="implement_ui">å‰ç«¯å¼€å‘</option>
                        <option value="implement_api">åç«¯å¼€å‘</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>æ—¶é—´èŒƒå›´</label>
                    <select id="timeFilter">
                        <option value="24">æœ€è¿‘24å°æ—¶</option>
                        <option value="168">æœ€è¿‘7å¤©</option>
                        <option value="720">æœ€è¿‘30å¤©</option>
                        <option value="all">å…¨éƒ¨</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button onclick="loadTasks()">ğŸ” æŸ¥è¯¢</button>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button onclick="loadRecentTasks()" style="background: #28a745;">ğŸ”„ åˆ·æ–°</button>
                </div>
            </div>
        </header>
        
        <div class="stats" id="stats">
            <div class="stat-card">
                <h3>æ€»ä»»åŠ¡æ•°</h3>
                <div class="value" id="totalTasks">-</div>
            </div>
            <div class="stat-card">
                <h3>è¿›è¡Œä¸­</h3>
                <div class="value" id="inProgressTasks">-</div>
            </div>
            <div class="stat-card">
                <h3>å·²å®Œæˆ</h3>
                <div class="value" id="completedTasks">-</div>
            </div>
            <div class="stat-card">
                <h3>å¤±è´¥</h3>
                <div class="value" id="failedTasks">-</div>
            </div>
        </div>
        
        <div class="task-list">
            <div id="loading" class="loading">åŠ è½½ä¸­...</div>
            <div id="error" class="error" style="display: none;"></div>
            <div id="empty" class="empty" style="display: none;">æš‚æ— ä»»åŠ¡</div>
            <table id="taskTable" style="display: none;">
                <thead>
                    <tr>
                        <th>ä»»åŠ¡ID</th>
                        <th>ç±»å‹</th>
                        <th>è§’è‰²</th>
                        <th>çŠ¶æ€</th>
                        <th>ä¼˜å…ˆçº§</th>
                        <th>åˆ›å»ºæ—¶é—´</th>
                        <th>æ‰§è¡Œæ—¶é•¿</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="taskTableBody">
                </tbody>
            </table>
        </div>
    </div>
    
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        const API_BASE = window.location.origin;
        
        // åˆå§‹åŒ–WebSocketè¿æ¥
        let socket = null;
        try {
            socket = io();
            
            socket.on('connect', function() {
                console.log('WebSocketå·²è¿æ¥');
                socket.emit('subscribe', {type: 'all'});
            });
            
            socket.on('task_update', function(data) {
                console.log('ä»»åŠ¡æ›´æ–°:', data);
                // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
                loadRecentTasks();
            });
            
            socket.on('statistics_update', function(data) {
                console.log('ç»Ÿè®¡æ›´æ–°:', data);
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                updateStatsFromData(data);
            });
            
            socket.on('disconnect', function() {
                console.log('WebSocketå·²æ–­å¼€');
            });
        } catch (e) {
            console.log('WebSocketä¸å¯ç”¨:', e);
        }
        
        function updateStatsFromData(stats) {
            document.getElementById('totalTasks').textContent = stats.total || 0;
            document.getElementById('inProgressTasks').textContent = stats.by_status?.in_progress || 0;
            document.getElementById('completedTasks').textContent = stats.by_status?.completed || 0;
            document.getElementById('failedTasks').textContent = stats.by_status?.failed || 0;
        }
        
        async function loadTasks() {
            const status = document.getElementById('statusFilter').value;
            const role = document.getElementById('roleFilter').value;
            const taskType = document.getElementById('typeFilter').value;
            
            let url = `${API_BASE}/api/tasks/history?limit=100`;
            if (status) url += `&status=${status}`;
            if (role) url += `&role_name=${role}`;
            if (taskType) url += `&task_type=${taskType}`;
            
            try {
                showLoading();
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    displayTasks(data.history);
                    updateStats(data.history);
                } else {
                    showError(data.error || 'åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                showError('ç½‘ç»œé”™è¯¯: ' + error.message);
            }
        }
        
        async function loadRecentTasks() {
            const hours = document.getElementById('timeFilter').value;
            
            let url = `${API_BASE}/api/tasks/history/recent?limit=100`;
            if (hours !== 'all') {
                url += `&hours=${hours}`;
            }
            
            try {
                showLoading();
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    displayTasks(data.tasks);
                    updateStats(data.tasks);
                } else {
                    showError(data.error || 'åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                showError('ç½‘ç»œé”™è¯¯: ' + error.message);
            }
        }
        
        function displayTasks(tasks) {
            const tbody = document.getElementById('taskTableBody');
            tbody.innerHTML = '';
            
            if (tasks.length === 0) {
                document.getElementById('empty').style.display = 'block';
                document.getElementById('taskTable').style.display = 'none';
                return;
            }
            
            document.getElementById('empty').style.display = 'none';
            document.getElementById('taskTable').style.display = 'table';
            
            tasks.forEach(task => {
                const row = document.createElement('tr');
                
                const duration = task.duration_seconds 
                    ? formatDuration(task.duration_seconds)
                    : '-';
                
                row.innerHTML = `
                    <td><code>${task.task_id.substring(0, 8)}...</code></td>
                    <td>${task.task_type}</td>
                    <td>${task.role_name || '-'}</td>
                    <td><span class="status ${task.status}">${getStatusText(task.status)}</span></td>
                    <td><span class="priority ${getPriorityClass(task.priority)}">${getPriorityText(task.priority)}</span></td>
                    <td>${formatDate(task.created_at)}</td>
                    <td>${duration}</td>
                    <td>
                        <div class="actions">
                            ${task.status === 'assigned' || task.status === 'pending' 
                                ? `<button class="btn-small btn-success" onclick="executeTask('${task.task_id}')">æ‰§è¡Œ</button>`
                                : ''}
                            <button class="btn-small" onclick="viewTask('${task.task_id}')">è¯¦æƒ…</button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        function updateStats(tasks) {
            const total = tasks.length;
            const inProgress = tasks.filter(t => t.status === 'in_progress').length;
            const completed = tasks.filter(t => t.status === 'completed').length;
            const failed = tasks.filter(t => t.status === 'failed').length;
            
            document.getElementById('totalTasks').textContent = total;
            document.getElementById('inProgressTasks').textContent = inProgress;
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('failedTasks').textContent = failed;
        }
        
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('taskTable').style.display = 'none';
            document.getElementById('empty').style.display = 'none';
        }
        
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').textContent = message;
            document.getElementById('taskTable').style.display = 'none';
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN');
        }
        
        function formatDuration(seconds) {
            if (seconds < 60) return `${Math.round(seconds)}ç§’`;
            if (seconds < 3600) return `${Math.round(seconds / 60)}åˆ†é’Ÿ`;
            return `${Math.round(seconds / 3600)}å°æ—¶`;
        }
        
        function getStatusText(status) {
            const map = {
                'pending': 'å¾…åˆ†é…',
                'assigned': 'å·²åˆ†é…',
                'in_progress': 'è¿›è¡Œä¸­',
                'completed': 'å·²å®Œæˆ',
                'failed': 'å¤±è´¥'
            };
            return map[status] || status;
        }
        
        function getPriorityClass(priority) {
            if (priority <= 1) return 'low';
            if (priority <= 2) return 'medium';
            if (priority <= 3) return 'high';
            return 'urgent';
        }
        
        function getPriorityText(priority) {
            const map = {1: 'ä½', 2: 'ä¸­', 3: 'é«˜', 4: 'ç´§æ€¥'};
            return map[priority] || priority;
        }
        
        async function executeTask(taskId) {
            try {
                const response = await fetch(`${API_BASE}/api/tasks/${taskId}/execute`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('ä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼');
                    loadRecentTasks();
                } else {
                    alert('æ‰§è¡Œå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('æ‰§è¡Œå¤±è´¥: ' + error.message);
            }
        }
        
        function viewTask(taskId) {
            window.location.href = `/tasks/${taskId}`;
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½æœ€è¿‘ä»»åŠ¡
        window.onload = function() {
            loadRecentTasks();
            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
            setInterval(loadRecentTasks, 30000);
        };
    </script>
</body>
</html>

